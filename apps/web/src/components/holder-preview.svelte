<script lang="ts">
  import type { LabelColor } from "$lib/types";

  interface Props {
    adapterColor: LabelColor;
    adapterHex: string;
    velcroColor: LabelColor;
    velcroHex: string;
  }

  const HEX_COLOR_REGEX = /^[\da-fA-F]{6}$/;
  const VELCRO_LUMA_SHIFT = -20;
  const HOLDER_LUMA_SHIFT = -24;
  const OUTLINE_LUMA_SHIFT = -14;
  const OUTLINE_RED_DIFF_THRESHOLD = 30;
  const OUTLINE_FALLBACK_HEX = "#b5afa6";

  let { adapterHex, velcroHex }: Props = $props();

  const clampChannel = (value: number): number => {
    return Math.max(0, Math.min(255, Math.round(value)));
  };

  const parseHex = (
    value?: string
  ): { blue: number; green: number; red: number } => {
    const normalized = (value?.trim() ?? "").replace("#", "");
    const hex =
      normalized.length === 3
        ? normalized
            .split("")
            .map((part) => `${part}${part}`)
            .join("")
        : normalized;

    if (!HEX_COLOR_REGEX.test(hex)) {
      return { red: 128, green: 128, blue: 128 };
    }

    return {
      red: Number.parseInt(hex.slice(0, 2), 16),
      green: Number.parseInt(hex.slice(2, 4), 16),
      blue: Number.parseInt(hex.slice(4, 6), 16),
    };
  };

  const toHex = (red: number, green: number, blue: number): string => {
    return `#${clampChannel(red).toString(16).padStart(2, "0")}${clampChannel(green).toString(16).padStart(2, "0")}${clampChannel(blue).toString(16).padStart(2, "0")}`;
  };

  const shiftLuma = (value: string, delta: number): string => {
    const rgb = parseHex(value);
    return toHex(rgb.red + delta, rgb.green + delta, rgb.blue + delta);
  };

  const velcroOuter = $derived(shiftLuma(velcroHex, VELCRO_LUMA_SHIFT));
  const holderDetail = $derived(shiftLuma(adapterHex, HOLDER_LUMA_SHIFT));
  const shellOutline = $derived(
    shiftLuma(
      Math.abs(parseHex(adapterHex).red - parseHex(velcroHex).red) <
        OUTLINE_RED_DIFF_THRESHOLD
        ? adapterHex
        : OUTLINE_FALLBACK_HEX,
      OUTLINE_LUMA_SHIFT
    )
  );
</script>

<div class="holder-preview">
  <svg
    viewBox="0 0 603 831"
    role="img"
    aria-label="Printable holder clip and velcro strap preview"
  >
    <path
      fill={shellOutline}
      transform="matrix(0.588867 0 0 0.588527 0 -0.00012207)"
      d="M502.774 174.851C546.428 171.326 606.935 182.979 647.688 198.967C723.758 228.867 787.242 283.996 827.506 355.118C843.827 384.004 858.933 416.821 868.094 448.751C891.547 530.492 895.555 648.336 877.363 731.779C873.385 749.86 868.265 767.67 862.034 785.102C857.98 796.409 852.295 809.731 849.152 821.018C873.205 828.794 872.699 827.279 877.799 852.797C884.76 887.633 888.808 922.37 886.663 957.976C886.254 964.761 886.568 972.736 884.241 979.238C878.155 993.064 844.27 1022.93 841.696 1036.42C839.019 1050.44 839.986 1085.26 839.71 1100.47C839.382 1118.6 838.511 1137.76 838.168 1155.86C814.631 1173.1 746.862 1190.58 716.818 1200.11L672.306 1214.04C665.516 1216.1 652.651 1220.3 645.828 1220.93C630.052 1222.39 612.515 1221.94 596.554 1221.9L504.237 1221.11C475.612 1221.11 446.127 1219.44 417.202 1219.47C396.545 1219.49 368.071 1219.56 348.206 1217.61C335.543 1216.36 305.774 1206.23 292.874 1202.16C272.407 1195.84 252.057 1189.15 231.834 1182.09C207.373 1173.78 187.584 1167.29 164.705 1154.59C158.47 1117.17 172.096 1060.62 157.931 1029.93C153.707 1020.78 147.963 1012.67 141.387 1005.07C134.188 996.763 118.001 983.948 114.757 973.992C112.673 967.596 113.056 959.582 112.792 952.863C111.266 913.938 115.434 889.445 127.42 852.64C129.979 844.783 132.112 835.903 135.936 828.617C139.255 827.044 145.082 825.195 148.71 823.924C133.319 784.835 120.968 737.216 118.394 695.21C113.266 611.551 131.71 488.571 164.527 411.415C182.39 368.834 207.139 329.481 237.781 294.934C256.664 273.563 289.544 243.863 313.933 228.75C354.775 203.442 408.542 185.739 456.089 178.875C469.986 176.868 488.682 175.726 502.774 174.851Z"
    ></path>
    <path
      fill="#f7f4ef"
      transform="matrix(0.588867 0 0 0.588527 0 -0.00012207)"
      d="M477.171 328.019C483.953 327.438 497.942 327.462 504.881 327.644C572.866 329.428 645.057 347.89 702.762 384.601C720.465 395.863 745.085 416.863 759.066 432.162C786.143 462.667 814.063 505.164 825.533 544.543C845.692 613.752 814.457 697.612 776.366 755.639C768.356 767.842 757.209 783.5 746.935 793.396C732.696 791.081 718.919 786.461 704.751 783.554C685.005 779.503 664.879 773.356 644.719 771.864C631.833 770.911 618.387 771.199 605.469 771.156C581.96 771.033 558.451 771.083 534.943 771.303L421.3 771.488C402.745 771.559 372.632 770.616 354.886 773.188C324.954 777.526 291.652 787.567 261.835 794.284C211.31 737.095 183.729 673.632 178.596 597.325C176.511 566.322 181.356 554.739 195.423 527.733C214.424 491.256 235.838 457.722 263.471 427.129C318.735 367.055 395.609 331.402 477.171 328.019Z"
    ></path>
    <path
      fill={adapterHex}
      transform="matrix(0.588867 0 0 0.588527 0 -0.00012207)"
      d="M484.219 777.197C524.238 776.128 564.646 777.51 604.592 776.761C638.328 776.129 657.635 778.83 689.983 786.363C706.837 790.199 723.628 794.307 740.349 798.685C734.689 804.093 728.284 810.585 726.289 818.414C724.342 826.056 730.895 906.279 732.949 917.44C733.626 921.117 734.704 923.704 736.646 926.88C737.554 927.443 738.473 927.986 739.438 928.448C748.143 932.611 764.231 932.503 773.089 929.059C788.761 922.965 823.051 871.523 832.069 855.857C837.518 846.391 842.025 836.614 846.351 826.594C853.777 828.971 860.706 830.997 867.417 835.078C873.129 856.432 879.219 891.522 879.841 912.776C860.214 937.43 818.982 943.891 789.947 950.977L725.866 967.082C715.926 969.533 706.024 972.132 696.161 974.877C688.843 976.907 673.837 981.496 666.792 981.707C646.921 982.302 625.614 981.853 605.753 981.514C576.919 981.105 548.082 980.967 519.245 981.097L393.551 981.248L358.181 981.417C335.358 981.581 331.228 980.701 309.031 974.822C295.293 971.184 281.536 967.617 267.761 964.121C242.056 957.597 216.023 951.89 190.356 945.13C168.765 939.443 131.279 928.554 120.278 907.575C121.817 889.984 133.016 850.513 140.232 833.312C144.022 831.978 147.993 830.715 151.818 829.439C162.676 853.631 175.694 875.865 191.186 897.404C195.641 903.597 200.095 910.079 205.297 915.675C214.029 925.068 223.41 930.017 236.351 930.303C244.052 930.473 263.228 929.031 268.73 923.335C275.868 915.945 284.893 830.789 284.822 817.728C280.474 811.037 272.664 804.894 266.507 799.566C294.56 793.17 323.095 783.97 351.587 779.812C367.108 777.547 385.634 778.07 401.576 777.941C429.125 777.912 456.673 777.664 484.219 777.197Z"
    ></path>
    <path
      fill={holderDetail}
      transform="matrix(0.588867 0 0 0.588527 0 -0.00012207)"
      d="M118.647 917.239C119.807 917.864 123.571 921.496 125.132 922.75C131.828 928.128 138.875 933.138 146.785 936.608C172.292 947.803 199.847 953.434 226.796 960.054C262.138 968.734 297.416 977.854 332.62 986.992C336.344 987.959 344.522 987.48 348.713 987.447C357.856 987.373 367.065 987.184 376.222 987.056C399.994 986.802 423.767 986.68 447.54 986.69L592.986 987.042C615.432 987.207 637.914 987.679 660.344 987.864C673.226 987.971 690.681 982.411 703.657 979.012L747.079 967.742C761.864 963.92 776.679 960.218 791.523 956.636C821.833 949.43 858.726 942.959 881.091 919.935C881.108 937.314 880.805 958.896 879.696 976.065C877.043 980.454 859.563 1001.44 856.113 1002.86C829.67 1013.8 790.834 1023.68 763.419 1030.8C740.652 1037.71 700.42 1043.04 683.461 1057.76C655.435 1082.08 658.262 1117.67 656.284 1150.82L652.056 1214.11C639.301 1216.12 622.56 1215.94 609.59 1215.9L561.6 1215.71C491.996 1215.3 422.398 1214.17 352.817 1212.33C352.401 1195.13 351.385 1175.66 350.183 1158.26C347.77 1129.44 350.43 1098.97 335.649 1072.89C322.122 1049.02 301.386 1045.96 277.406 1039.89C263.205 1036.38 249.043 1032.71 234.921 1028.88C217.398 1024 199.681 1018.73 182.224 1013.59C170.478 1010.14 159.584 1005.88 147.518 1002.72C138.183 992.939 120.205 977.798 119.482 964.469C118.657 949.271 118.701 932.477 118.647 917.239Z"
    ></path>
    <path
      fill={velcroOuter}
      transform="matrix(0.588867 0 0 0.588527 0 -0.00012207)"
      d="M500.535 180.366C511.598 179.257 526.508 179.995 537.698 180.574C693.264 188.628 814.406 296.265 860.072 442.201C866.752 463.61 872 485.44 875.784 507.545C885.414 566.7 886.028 657.147 874.844 716.09C865.947 762.082 850.474 806.553 828.899 848.135C820.262 864.598 791.432 906.541 777.037 918.362C774.159 920.754 770.83 922.545 767.247 923.627C761.516 925.343 750.56 926.283 745.173 923.05C740.023 919.96 738.966 912.681 737.695 907.174C750.692 889.785 764.735 873.79 777.082 855.905C880.317 706.378 893.707 509.311 760.039 372.349C693.908 304.589 606.616 273.91 512.731 271.83C356.168 269.458 224.045 360.627 170.373 507.925C126.412 628.574 161.25 756.612 230.679 859.835C241.495 875.915 255.427 888.92 266.435 903.967L267.004 904.753C267.567 920.281 262.795 919.642 250.262 922.347C217.31 929.459 203.748 904.758 187.512 880.358C149.301 823.828 127.297 757.918 123.886 689.773C122 653.699 124.653 617.076 128.859 581.32C141.475 474.057 171.558 376.477 245.432 295.23C314.976 218.746 398.227 185.595 500.535 180.366Z"
    ></path>
    <path
      fill={velcroHex}
      transform="matrix(0.588867 0 0 0.588527 0 -0.00012207)"
      d="M500.09 277.677C508.732 277.33 524.712 277.989 533.266 278.631C625.082 285.53 706.955 320.199 767.998 389.937C827.361 458.136 857.231 547.101 851.052 637.301C845.736 717.377 808.753 803.696 760.463 867.498C754.933 874.805 743.066 891.039 736.548 896.736C736.086 875.175 730.681 841.579 732.197 820.465C732.652 814.129 756.535 791.927 762.913 784.047C804.293 732.923 831.621 667.029 837.132 601.391C841.314 548.368 817.781 503.318 788.929 461.082C726.08 369.08 620.737 327.957 511.785 322.354C446.439 320.619 391.511 330.593 334.15 363.856C316.137 374.301 304.355 381.605 288.249 395.475C247.36 430.687 215.979 475.178 191.6 523.046C183.696 538.567 174.359 553.168 173.56 571.263C170.381 643.208 194.128 717.504 238.211 774.492C246.311 784.964 254.586 794.709 263.583 804.306C268.325 809.364 273.923 813.684 278.314 818.861L278.818 819.463C278.416 843.479 271.866 873.375 269.124 897.436C261.431 889.338 253.354 878.631 246.472 869.785C196.302 805.303 160.625 717.228 157.395 635.206C154.199 543.24 187.96 453.823 251.143 386.914C317.865 315.1 403.295 281.189 500.09 277.677Z"
    ></path>
    <path
      fill={holderDetail}
      transform="matrix(0.588867 0 0 0.588527 0 -0.00012207)"
      d="M153.925 1010.36C157.461 1011.16 169.292 1015.76 173.625 1017.18C187.33 1021.54 201.116 1025.64 214.978 1029.47C232.273 1034.28 249.589 1038.96 266.958 1043.48C278.983 1046.62 293.871 1049.14 305.281 1053.65C312.477 1056.41 318.886 1060.9 323.947 1066.71C341.067 1086.11 342.059 1113.45 343.401 1137.83L345.266 1172.31C345.634 1179.11 347.836 1206.4 347.492 1211.4C325.668 1207.76 289.774 1195.48 268.074 1188.09C240.846 1178.81 194.04 1164.82 169.794 1150.37C169.063 1122.58 169.356 1096 170.364 1068.17C171.175 1045.79 166.545 1029.1 153.925 1010.36Z"
    ></path>
    <path
      fill={holderDetail}
      transform="matrix(0.588867 0 0 0.588527 0 -0.00012207)"
      d="M849.727 1011.49L850.221 1011.62C850.233 1014.52 835.743 1026.41 835.31 1036.87C833.726 1075.08 832.74 1114.35 832.192 1152.58C805.464 1168.14 764.406 1179.48 734.168 1188.94C710.12 1196.46 683.173 1205.53 659.133 1212.24L658.017 1211.43C657.73 1198.38 660.379 1176.26 661.132 1162.15C662.79 1142.1 662.933 1121.99 665.802 1102.05C668.41 1083.93 678.988 1065.65 695.032 1056.25C702.481 1052.22 711.135 1050.22 719.267 1048.18C755.456 1039.07 791.49 1029.33 827.4 1019.19C834.868 1017.08 842.271 1013.9 849.727 1011.49Z"
    ></path>
  </svg>
</div>
