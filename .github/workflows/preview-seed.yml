name: preview-seed

on:
  deployment_status:

permissions:
  contents: read
  deployments: read
  pull-requests: read

jobs:
  seed-preview:
    name: Seed Convex preview catalog
    if: >
      github.event.deployment_status.state == 'success' &&
      (
        startsWith(github.event.deployment.environment || '', 'Preview') ||
        startsWith(github.event.deployment_status.environment || '', 'Preview')
      )
    concurrency:
      group: preview-seed-${{ github.event.deployment.id }}
      cancel-in-progress: false
    runs-on: ubuntu-latest
    env:
      PREVIEW_URL: ${{ github.event.deployment_status.environment_url || github.event.deployment_status.target_url || github.event.deployment.environment_url || '' }}
      DEPLOYMENT_ID: ${{ github.event.deployment.id }}
      DEPLOYMENT_REF: ${{ github.event.deployment.ref }}
      DEPLOYMENT_SHA: ${{ github.event.deployment.sha }}
      CONVEX_DEPLOY_KEY: ${{ secrets.CONVEX_DEPLOY_KEY_PREVIEW }}
    steps:
      - name: Resolve pull request context
        id: pr
        uses: actions/github-script@v7
        env:
          DEPLOY_REF: ${{ env.DEPLOYMENT_REF }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const rawRef = process.env.DEPLOY_REF ?? "";
            const repo = context.repo;
            const match = rawRef.match(/^refs\/pull\/(\d+)\/merge$/);
            if (match) {
              const pull_number = Number.parseInt(match[1], 10);
              const { data: pr } = await github.rest.pulls.get({
                ...repo,
                pull_number,
              });
              if (pr.state !== "open") {
                core.info(`PR #${pull_number} is not open; skipping preview seed.`);
                core.setOutput("skip", "true");
                return;
              }
              core.info(`Detected PR #${pull_number} from deployment ref ${rawRef}.`);
              core.setOutput("skip", "false");
              core.setOutput("number", String(pr.number));
              core.setOutput("title", pr.title ?? "");
              core.setOutput("headSha", pr.head?.sha ?? "");
              return;
            }

            const normalized =
              rawRef.startsWith("refs/heads/") ?
                rawRef.replace("refs/heads/", "") :
                rawRef;
            if (!normalized) {
              core.warning("Empty deployment ref; skipping preview seed.");
              core.setOutput("skip", "true");
              return;
            }
            const { data: prs } = await github.rest.pulls.list({
              ...repo,
              head: `${repo.owner}:${normalized}`,
              state: "open",
              per_page: 1,
            });
            if (prs.length === 0) {
              core.info(`No open PR found for branch ${normalized}; skipping preview seed.`);
              core.setOutput("skip", "true");
              return;
            }
            const pr = prs[0];
            core.info(`Preview deployment belongs to PR #${pr.number} (${pr.title}).`);
            core.setOutput("skip", "false");
            core.setOutput("number", String(pr.number));
            core.setOutput("title", pr.title ?? "");
            core.setOutput("headSha", pr.head?.sha ?? "");

      - name: Skip when deployment has no matching PR
        if: steps.pr.outputs.skip == 'true'
        run: |
          echo "Preview deployment ${DEPLOYMENT_ID} is not tied to an open PR; skipping seed run."

      - name: Validate preview URL
        if: steps.pr.outputs.skip != 'true'
        run: |
          if [ -z "${PREVIEW_URL:-}" ]; then
            echo "Deployment status event did not include an environment URL."
            exit 1
          fi
          case "${PREVIEW_URL}" in
            http://*|https://*) ;;
            *)
              echo "Deployment URL '${PREVIEW_URL}' is invalid; expected http(s) URL."
              exit 1
              ;;
          esac
          echo "Seeding preview deployment at ${PREVIEW_URL}"

      - name: Check Convex credentials
        if: steps.pr.outputs.skip != 'true'
        run: |
          if [ -z "${CONVEX_DEPLOY_KEY:-}" ]; then
            echo "CONVEX_DEPLOY_KEY_PREVIEW secret is not configured."
            exit 1
          fi

      - name: Checkout
        if: steps.pr.outputs.skip != 'true'
        uses: actions/checkout@v4

      - name: Setup Bun
        if: steps.pr.outputs.skip != 'true'
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: 1.3.8

      - name: Install dependencies
        if: steps.pr.outputs.skip != 'true'
        run: |
          set -euo pipefail
          bun install --frozen-lockfile || (
            echo "bun install failed; clearing Bun cache and retrying" >&2
            bun pm cache rm
            bun install --frozen-lockfile
          )

      - name: Seed preview catalog
        id: seed
        if: steps.pr.outputs.skip != 'true'
        env:
          VERCEL_URL: ${{ env.PREVIEW_URL }}
        run: |
          set -euo pipefail
          LOG_FILE="$RUNNER_TEMP/preview-seed.log"
          echo "log=$LOG_FILE" >> "$GITHUB_OUTPUT"
          {
            echo "Target preview: ${VERCEL_URL}"
            bun run scripts/seed-vercel-deployment.ts --vercel-url "${VERCEL_URL}"
          } | tee "$LOG_FILE"

      - name: Publish summary
        if: steps.pr.outputs.skip != 'true' && always()
        env:
          SUMMARY_STATUS: ${{ job.status }}
          PR_NUMBER: ${{ steps.pr.outputs.number }}
          PR_TITLE: ${{ steps.pr.outputs.title }}
          LOG_PATH: ${{ steps.seed.outputs.log }}
          PREVIEW_URL: ${{ env.PREVIEW_URL }}
        run: |
          {
            echo "## Preview seed status"
            echo ""
            echo "- Deployment ID: ${DEPLOYMENT_ID}"
            echo "- Preview URL: ${PREVIEW_URL}"
            if [ -n "${PR_NUMBER:-}" ]; then
              echo "- PR: #${PR_NUMBER} ${PR_TITLE}"
            fi
            echo "- Result: ${SUMMARY_STATUS}"
            echo "- SHA: ${DEPLOYMENT_SHA}"
          } >> "$GITHUB_STEP_SUMMARY"

          if [ -n "${LOG_PATH:-}" ] && [ -f "${LOG_PATH}" ]; then
            {
              echo ""
              echo "<details>"
              echo "<summary>Seed output (tail)</summary>"
              echo ""
              tail -n 50 "${LOG_PATH}"
              echo ""
              echo "</details>"
            } >> "$GITHUB_STEP_SUMMARY"
          fi
