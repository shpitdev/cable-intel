name: cd-publish-release

on:
  pull_request_target:
    types:
      - closed
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: cd-publish-release-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  publish-release:
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'pull_request_target' &&
      github.event.pull_request.merged == true &&
      github.event.pull_request.base.ref == 'main' &&
      startsWith(github.event.pull_request.title, 'chore: bump version to '))
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.merge_commit_sha || 'main' }}
          fetch-depth: 0

      - name: Read current version
        id: version
        run: |
          VERSION=$(node -e "const fs=require('node:fs');const pkg=JSON.parse(fs.readFileSync('package.json','utf8'));process.stdout.write(String(pkg.version ?? ''));")
          if [ -z "$VERSION" ]; then
            echo "package.json version is empty"
            exit 1
          fi
          echo "value=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Skip if release already exists
        id: release_exists
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="v${{ steps.version.outputs.value }}"
          if gh release view "$TAG" --repo "$GITHUB_REPOSITORY" >/dev/null 2>&1; then
            echo "skip=true" >> "$GITHUB_OUTPUT"
            echo "Release $TAG already exists; skipping."
          else
            echo "skip=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Create GitHub release and tag
        if: steps.release_exists.outputs.skip != 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="v${{ steps.version.outputs.value }}"
          gh release create "$TAG" \
            --repo "$GITHUB_REPOSITORY" \
            --title "Release $TAG" \
            --generate-notes \
            --target "$GITHUB_SHA"
